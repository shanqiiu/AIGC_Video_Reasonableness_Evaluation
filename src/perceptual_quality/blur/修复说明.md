# 模糊检测逻辑修复说明

## 修复日期
2024年修复

## 修复目的
统一 `AIGC_Video_Reasonableness_Evaluation` 和 `VMBench_diy` 两个工程的模糊检测逻辑，确保在相同视频上得到一致的评测结果。

## 修复内容

### 1. 模糊帧检测逻辑 (`_get_artifacts_frames`)

**修复前：**
- 使用绝对值检测：直接比较质量分数与阈值
- 逻辑：`if score < threshold`

**修复后：**
- 使用帧间差异检测：比较相邻帧的质量分数差异
- 逻辑：`if abs(diff(score)) > threshold`
- 与 VMBench 保持一致

**原因：**
- 帧间差异更能反映运动相关的模糊问题
- 符合"运动平滑度"的原始定义

### 2. 阈值设置逻辑 (`_set_threshold`)

**修复前：**
- 使用线性调整：基于基础阈值的线性调整
- 逻辑：`base * (1.0 + 0.5 * camera_movement)`

**修复后：**
- 使用分段阈值：根据相机运动幅度返回固定阈值
- 逻辑：
  - `camera_movement < 0.1`: 0.01
  - `0.1 <= camera_movement < 0.3`: 0.015
  - `0.3 <= camera_movement < 0.5`: 0.025
  - `camera_movement >= 0.5`: 0.03
- 与 VMBench 保持一致

### 3. PAS 分数归一化 (`pas_scorer.py`)

**修复前：**
- 直接使用 `pure_subject_motion` 作为 PAS 分数
- 未进行归一化处理

**修复后：**
- 对 `pure_subject_motion` 进行归一化：`pas_score = min(1.0, pure_subject_motion * 10)`
- 与 VMBench 保持一致

### 4. 模糊比例计算

**修复前：**
- 假设总帧数为 100：`blur_ratio = len(blur_frames) / 100`

**修复后：**
- 使用实际总帧数：`blur_ratio = len(blur_frames) / total_frames`
- 更准确地计算模糊比例

## 修复的文件

1. `AIGC_Video_Reasonableness_Evaluation/src/perceptual_quality/blur/blur_detection_pipeline.py`
   - `_get_artifacts_frames()` 方法
   - `_set_threshold()` 方法
   - `_calculate_blur_severity()` 方法
   - `_detect_blur_with_mss()` 方法
   - `_combine_blur_detection()` 方法
   - `_generate_blur_report()` 方法

2. `AIGC_Video_Reasonableness_Evaluation/src/perceptual_quality/blur/pas_scorer.py`
   - `score()` 方法中的 PAS 分数归一化处理

## 验证

修复后，两个工程应该能够在相同视频上得到一致的评测结果。主要的改进包括：

1. **更准确的模糊检测**：使用帧间差异检测，能更好地识别运动相关的模糊问题
2. **更合理的阈值设置**：使用分段阈值，更符合实际应用场景
3. **一致的分数范围**：PAS 分数归一化后，范围统一为 0-1
4. **更准确的比例计算**：使用实际帧数计算模糊比例

## 注意事项

- 修复后的逻辑与 VMBench 保持一致，但在某些边界情况下可能会有细微差异
- 建议在使用前对修复后的代码进行测试验证
- 如果发现问题，请参考 `VMBench_diy/blur/逻辑差异分析.md` 进行对比

